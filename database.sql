-- =============================================
-- SAFELY DROP CONSTRAINTS FIRST
-- =============================================
IF OBJECT_ID('dbo.PARCELA_CONDPAG', 'U') IS NOT NULL
BEGIN
    ALTER TABLE PARCELA_CONDPAG DROP CONSTRAINT IF EXISTS FK_PARCELA_CONDPAG;
    ALTER TABLE PARCELA_CONDPAG DROP CONSTRAINT IF EXISTS FK_PARCELA_FORMAPAG;
    ALTER TABLE PARCELA_CONDPAG DROP CONSTRAINT IF EXISTS FK_PARCELA_CONDPAG_USR_ALT;
END

IF OBJECT_ID('dbo.CLIENTE', 'U') IS NOT NULL
BEGIN
    ALTER TABLE CLIENTE DROP CONSTRAINT IF EXISTS FK_CLIENTE_CIDADE;
    ALTER TABLE CLIENTE DROP CONSTRAINT IF EXISTS FK_CLIENTE_CONDPAG;
    ALTER TABLE CLIENTE DROP CONSTRAINT IF EXISTS FK_CLIENTE_USR_ALT;
END

IF OBJECT_ID('dbo.FORNECEDOR', 'U') IS NOT NULL
BEGIN
    ALTER TABLE FORNECEDOR DROP CONSTRAINT IF EXISTS FK_FORNECEDOR_CIDADE;
    ALTER TABLE FORNECEDOR DROP CONSTRAINT IF EXISTS FK_FORNECEDOR_CONDPAG;
    ALTER TABLE FORNECEDOR DROP CONSTRAINT IF EXISTS FK_FORNECEDOR_USR_ALT;
END

IF OBJECT_ID('dbo.FUNCIONARIO', 'U') IS NOT NULL
BEGIN
    ALTER TABLE FUNCIONARIO DROP CONSTRAINT IF EXISTS FK_FUNCIONARIO_CIDADE;
    ALTER TABLE FUNCIONARIO DROP CONSTRAINT IF EXISTS FK_FUNCIONARIO_USR_ALT;
END

IF OBJECT_ID('dbo.COND_PAGAMENTO', 'U') IS NOT NULL
    ALTER TABLE COND_PAGAMENTO DROP CONSTRAINT IF EXISTS FK_CONDPAG_USR_ALT;

IF OBJECT_ID('dbo.FORMA_PAGAMENTO', 'U') IS NOT NULL
    ALTER TABLE FORMA_PAGAMENTO DROP CONSTRAINT IF EXISTS FK_FORMAPAG_USR_ALT;

IF OBJECT_ID('dbo.PAIS', 'U') IS NOT NULL
    ALTER TABLE PAIS DROP CONSTRAINT IF EXISTS FK_PAIS_USR_ALT;

IF OBJECT_ID('dbo.ESTADO', 'U') IS NOT NULL
BEGIN
    ALTER TABLE ESTADO DROP CONSTRAINT IF EXISTS FK_ESTADO_PAIS;
    ALTER TABLE ESTADO DROP CONSTRAINT IF EXISTS FK_ESTADO_USR_ALT;
END

IF OBJECT_ID('dbo.CIDADE', 'U') IS NOT NULL
BEGIN
    ALTER TABLE CIDADE DROP CONSTRAINT IF EXISTS FK_CIDADE_ESTADO;
    ALTER TABLE CIDADE DROP CONSTRAINT IF EXISTS FK_CIDADE_USR_ALT;
END

-- =============================================
-- DROP TABLES IN CORRECT ORDER
-- =============================================

DROP TABLE IF EXISTS FORNECEDOR;
DROP TABLE IF EXISTS CLIENTE;
DROP TABLE IF EXISTS PARCELA_CONDPAG;
DROP TABLE IF EXISTS FORMA_PAGAMENTO;
DROP TABLE IF EXISTS COND_PAGAMENTO;
DROP TABLE IF EXISTS FUNCIONARIO;
DROP TABLE IF EXISTS CIDADE;
DROP TABLE IF EXISTS ESTADO;
DROP TABLE IF EXISTS PAIS;
GO

-- =============================================
-- CREATE DATABASE (if needed)
-- =============================================

IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'projeto_pratica')
    CREATE DATABASE projeto_pratica;
GO

USE projeto_pratica;
GO

-- PAIS
CREATE TABLE PAIS (
    PAIS_ID INT IDENTITY(1,1) PRIMARY KEY,
    PAIS_NOME NVARCHAR(255) NOT NULL,
    PAIS_SIGLA NVARCHAR(10),
    PAIS_MOEDA NVARCHAR(50),
    PAIS_DDI NVARCHAR(10),
    ATIVO BIT DEFAULT 1,

    PAIS_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    PAIS_DT_ALT DATETIME,
    PAIS_USR_ALT INT
);
GO

-- ESTADO
CREATE TABLE ESTADO (
    ESTADO_ID INT IDENTITY(1,1) PRIMARY KEY,
    ESTADO_NOME NVARCHAR(255) NOT NULL,
    ESTADO_UF NVARCHAR(5) NOT NULL,
    PAIS_ID INT NOT NULL,
    ATIVO BIT DEFAULT 1,

    ESTADO_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    ESTADO_DT_ALT DATETIME,
    ESTADO_USR_ALT INT
);
GO

-- CIDADE
CREATE TABLE CIDADE (
    CIDADE_ID INT IDENTITY(1,1) PRIMARY KEY,
    CIDADE_NOME NVARCHAR(255) NOT NULL,
    CIDADE_DDD NVARCHAR(5),
    ESTADO_ID INT NOT NULL,
    ATIVO BIT DEFAULT 1,

    CIDADE_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    CIDADE_DT_ALT DATETIME,
    CIDADE_USR_ALT INT
);
GO

-- FUNCIONARIO
CREATE TABLE FUNCIONARIO (
    FUNCIONARIO_ID INT IDENTITY(1,1) PRIMARY KEY,

    FUNCIONARIO_TIPO CHAR(1) NOT NULL,
    FUNCIONARIO_NOME NVARCHAR(255) NOT NULL,
    FUNCIONARIO_APELIDO VARCHAR(255),
    FUNCIONARIO_NASCIMENTO DATE NOT NULL,
    FUNCIONARIO_CPF VARCHAR(20) NOT NULL,
    FUNCIONARIO_RG VARCHAR(20),
    FUNCIONARIO_EMAIL NVARCHAR(255),
    FUNCIONARIO_TELEFONE NVARCHAR(20),
    
    FUNCIONARIO_ENDERECO NVARCHAR(255),
    FUNCIONARIO_NUM VARCHAR(10),
    FUNCIONARIO_COMPLEMENTO VARCHAR(100),
    FUNCIONARIO_BAIRRO NVARCHAR(100),
    FUNCIONARIO_CEP NVARCHAR(15),
    
    FUNCIONARIO_MATRICULA NVARCHAR(50),
    FUNCIONARIO_CARGO NVARCHAR(100),
    FUNCIONARIO_SALBRUTO FLOAT,
    FUNCIONARIO_GRATPROD FLOAT,
    FUNCIONARIO_SALLIQ FLOAT,
    FUNCIONARIO_DATA_ADMISSAO DATE,
    FUNCIONARIO_DATA_DEMISSAO DATE,
    FUNCIONARIO_TURNO NVARCHAR(50),
    FUNCIONARIO_CARGA_HORARIA INT,

    CIDADE_ID INT NOT NULL,
    ATIVO BIT DEFAULT 1,

    FUNCIONARIO_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    FUNCIONARIO_DT_ALT DATETIME,
    FUNCIONARIO_USR_ALT INT
);
GO

-- COND_PAGAMENTO
CREATE TABLE COND_PAGAMENTO (
    CONDPAG_ID INT IDENTITY(1,1) PRIMARY KEY,
    CONDPAG_DESC NVARCHAR(255) NOT NULL,
    CONDPAG_PARCELAS INT NOT NULL,
    CONDPAG_JURO DECIMAL(5,2) NOT NULL,
    CONDPAG_MULTA DECIMAL(5,2) NOT NULL,
    CONDPAG_DESCONTO DECIMAL(5,2) NOT NULL,
    ATIVO BIT DEFAULT 1,

    CONDPAG_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    CONDPAG_DT_ALT DATETIME,
    CONDPAG_USR_ALT INT
);
GO

-- FORMA_PAGAMENTO
CREATE TABLE FORMA_PAGAMENTO (
    FORMAPAG_ID INT IDENTITY(1,1) PRIMARY KEY,
    FORMAPAG_DESC NVARCHAR(255) NOT NULL,
    ATIVO BIT DEFAULT 1,

    FORMAPAG_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    FORMAPAG_DT_ALT DATETIME,
    FORMAPAG_USR_ALT INT
);
GO

-- PARCELA_CONDPAG
CREATE TABLE PARCELA_CONDPAG (
    PARCELA_ID INT IDENTITY(1,1) PRIMARY KEY,
    CONDPAG_ID INT NOT NULL,
    FORMAPAG_ID INT NOT NULL,
    PARCELA_PERCT DECIMAL(5,2) NOT NULL,
    PARCELA_NUM INT NOT NULL,
    PARCELA_PRAZO INT NOT NULL,
    ATIVO BIT DEFAULT 1,

    PARCELA_CONDPAG_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    PARCELA_CONDPAG_DT_ALT DATETIME,
    PARCELA_CONDPAG_USR_ALT INT
);
GO

-- CLIENTE
CREATE TABLE CLIENTE (
    CLIENTE_ID INT IDENTITY(1,1) PRIMARY KEY,

    CLIENTE_TIPO CHAR(1) NOT NULL,
    CLIENTE_NOME_RS NVARCHAR(255) NOT NULL,
    CLIENTE_APELIDO_FANTASIA NVARCHAR(255),
    CLIENTE_NASCIMENTO DATE NOT NULL,
    CLIENTE_CPF_CNPJ NVARCHAR(20) NOT NULL,
    CLIENTE_RG_INSCR NVARCHAR(20),
    CLIENTE_EMAIL NVARCHAR(255),
    CLIENTE_TELEFONE NVARCHAR(20),

    CLIENTE_ENDERECO NVARCHAR(255) NOT NULL,
    CLIENTE_NUM VARCHAR(10),
    CLIENTE_COMPLEMENTO VARCHAR(100),
    CLIENTE_BAIRRO NVARCHAR(100) NOT NULL,
    CLIENTE_CEP NVARCHAR(20) NOT NULL,

	CLIENTE_LIMITE_CREDITO FLOAT,

    CIDADE_ID INT NOT NULL,
    CONDPAG_ID INT NOT NULL,

    ATIVO BIT DEFAULT 1,
    CLIENTE_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    CLIENTE_DT_ALT DATETIME,
    CLIENTE_USR_ALT INT
);
GO

-- FORNECEDOR
CREATE TABLE FORNECEDOR (
    FORNECEDOR_ID INT IDENTITY(1,1) PRIMARY KEY,

    FORNECEDOR_TIPO CHAR(1),
    FORNECEDOR_NOME_RS NVARCHAR(255) NOT NULL,
    FORNECEDOR_APELIDO_FANTASIA NVARCHAR(255),
    FORNECEDOR_CPF_CNPJ NVARCHAR(20) NOT NULL,
    FORNECEDOR_RG_INSCR NVARCHAR(20),
    FORNECEDOR_NASCIMENTO DATE NOT NULL,
    FORNECEDOR_EMAIL NVARCHAR(255),
    FORNECEDOR_TELEFONE NVARCHAR(20),
    FORNECEDOR_ENDERECO NVARCHAR(255),
    FORNECEDOR_NUM VARCHAR(10),
    FORNECEDOR_COMPLEMENTO VARCHAR(100),
    FORNECEDOR_BAIRRO NVARCHAR(100),
    FORNECEDOR_CEP NVARCHAR(20),

    CIDADE_ID INT NOT NULL,
    CONDPAG_ID INT NOT NULL,
    LIMITE_CREDITO FLOAT,
    ATIVO BIT DEFAULT 1,

    FORNECEDOR_DT_CRIACAO DATETIME DEFAULT GETDATE(),
    FORNECEDOR_DT_ALT DATETIME,
    FORNECEDOR_USR_ALT INT
);
GO


ALTER TABLE FUNCIONARIO 
ADD CONSTRAINT FK_FUNCIONARIO_CIDADE FOREIGN KEY (CIDADE_ID) REFERENCES CIDADE(CIDADE_ID),
    CONSTRAINT FK_FUNCIONARIO_USR_ALT FOREIGN KEY (FUNCIONARIO_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE COND_PAGAMENTO 
ADD CONSTRAINT FK_CONDPAG_USR_ALT FOREIGN KEY (CONDPAG_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE FORMA_PAGAMENTO 
ADD CONSTRAINT FK_FORMAPAG_USR_ALT FOREIGN KEY (FORMAPAG_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE PARCELA_CONDPAG 
ADD CONSTRAINT FK_PARCELA_CONDPAG FOREIGN KEY (CONDPAG_ID) REFERENCES COND_PAGAMENTO(CONDPAG_ID) ON DELETE CASCADE,
    CONSTRAINT FK_PARCELA_FORMAPAG FOREIGN KEY (FORMAPAG_ID) REFERENCES FORMA_PAGAMENTO(FORMAPAG_ID) ON DELETE CASCADE,
    CONSTRAINT FK_PARCELA_CONDPAG_USR_ALT FOREIGN KEY (PARCELA_CONDPAG_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE PAIS 
ADD CONSTRAINT FK_PAIS_USR_ALT FOREIGN KEY (PAIS_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE ESTADO 
ADD CONSTRAINT FK_ESTADO_PAIS FOREIGN KEY (PAIS_ID) REFERENCES PAIS(PAIS_ID) ON DELETE CASCADE,
    CONSTRAINT FK_ESTADO_USR_ALT FOREIGN KEY (ESTADO_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE CIDADE 
ADD CONSTRAINT FK_CIDADE_ESTADO FOREIGN KEY (ESTADO_ID) REFERENCES ESTADO(ESTADO_ID) ON DELETE CASCADE,
    CONSTRAINT FK_CIDADE_USR_ALT FOREIGN KEY (CIDADE_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE CLIENTE 
ADD CONSTRAINT FK_CLIENTE_CIDADE FOREIGN KEY (CIDADE_ID) REFERENCES CIDADE(CIDADE_ID),
    CONSTRAINT FK_CLIENTE_CONDPAG FOREIGN KEY (CONDPAG_ID) REFERENCES COND_PAGAMENTO(CONDPAG_ID),
    CONSTRAINT FK_CLIENTE_USR_ALT FOREIGN KEY (CLIENTE_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);

ALTER TABLE FORNECEDOR 
ADD CONSTRAINT FK_FORNECEDOR_CIDADE FOREIGN KEY (CIDADE_ID) REFERENCES CIDADE(CIDADE_ID),
    CONSTRAINT FK_FORNECEDOR_CONDPAG FOREIGN KEY (CONDPAG_ID) REFERENCES COND_PAGAMENTO(CONDPAG_ID),
    CONSTRAINT FK_FORNECEDOR_USR_ALT FOREIGN KEY (FORNECEDOR_USR_ALT) REFERENCES FUNCIONARIO(FUNCIONARIO_ID);
GO
